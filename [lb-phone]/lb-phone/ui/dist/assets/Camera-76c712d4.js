import{u as A,r as s,q as o,b9 as se,_ as ne,A as $,ba as P,P as y,ax as q,p as d,C as V,a as n,F as Q,j as g,bb as ie,bc as oe,bd as ce,L as _,s as R,be as le,aS as ue,a2 as de,t as fe,a6 as me,a$ as ge,b as he,T as ve}from"./index-594e1857.js";function Ce(){var W;const T=A(he),x=A(P.Unlocked),J=A(P.PassedFaceId),p=A(P.Visible),[E,C]=s.useState(!1),[c,N]=s.useState("Photo"),[S,U]=s.useState(!1),[Y,K]=s.useState(!1),[z,k]=s.useState(null),[h,D]=s.useState(!1),[f,O]=s.useState(!1),[Z,j]=s.useState(0),[ee,w]=s.useState({}),l=A(ve),u=A($),F=s.useRef(null),L=s.useRef(null),I=s.useRef(null),i=s.useRef(null),v=s.useRef(!1),m=["Video","Photo","Landscape"],X=()=>{c==="Photo"&&h&&!T.CustomCamera?i.current.setXOffset(-.2):h&&T.CustomCamera?i.current.setXOffset(.1):i.current.setXOffset(0)},te=()=>{if(o("info","Camera app is active & open, initializing game render & audio stream"),d("Camera",{action:"open"}),i.current&&i.current.resume(),d("Camera",{action:"flipCamera",value:h},"OK"),R.APPS.CAMERA.lastImage.value)return M(R.APPS.CAMERA.lastImage.value);d("Camera",{action:"getLastImage"},ue.Photos[0].src).then(e=>{e&&M(e)})},ae=()=>{o("info","Camera app is not active or open, pausing game render & releasing audio stream"),d("Camera",{action:"close"}),f&&O(!1),i.current&&i.current.pause()};s.useEffect(()=>{var r,t;const e=!(l!=null&&l.visible)&&((r=u==null?void 0:u.active)==null?void 0:r.name)==="Camera"&&p;v.current!==e&&(v.current=e,o("info","Camera app active:",e,l==null?void 0:l.visible,(t=u==null?void 0:u.active)==null?void 0:t.name,p),e?te():ae())},[l==null?void 0:l.visible,(W=u==null?void 0:u.active)==null?void 0:W.name,i.current,p]),s.useEffect(()=>{I.current&&v.current&&(i.current||(o("info","Initializing game render"),i.current=new se(I.current)))},[I.current]),s.useEffect(()=>()=>{o("info","Cleaning up camera app"),i.current&&(o("info","Destroying game render"),i.current.destroy(),i.current=null)},[]),ne("camera:usedCommand",e=>{var r;if(l!=null&&l.visible||((r=u==null?void 0:u.active)==null?void 0:r.name)!=="Camera"||!p)return o("info","camera:usedCommand - camera is not active, returning");switch(e){case"toggleTaking":H();break;case"toggleFlip":D(t=>!t);break;case"toggleFlash":U(t=>!t);break;case"leftMode":if(f)return;N(t=>{const a=m.indexOf(t);return a===0?m[m.length-1]:m[a-1]});break;case"rightMode":if(f)return;N(t=>{const a=m.indexOf(t);return a===m.length-1?m[0]:m[a+1]});break}}),s.useEffect(()=>{if(!L.current)return;let e=[];const t=setInterval(()=>{e.length>2&&(e=[]),e.push("."),L.current.innerText=_("APPS.CAMERA.UPLOADING")+e.join("")},500);return()=>clearInterval(t)},[E]);const M=(e,r)=>{if(r===void 0&&(r=de(e)),r){const t=document.createElement("video");t.src=e,t.muted=!0,t.play().catch(()=>{});const a=document.createElement("canvas");if(!a)return;t.addEventListener("loadeddata",()=>{a.width=t.videoWidth,a.height=t.videoHeight,a.getContext("2d").drawImage(t,0,0,a.width,a.height);const b=a.toDataURL("image/png");F.current.style.backgroundImage=`url(${b})`,R.APPS.CAMERA.lastImage.set(b),a.remove(),t.remove()})}else F.current.style.backgroundImage=`url(${e})`,R.APPS.CAMERA.lastImage.set(e)};s.useEffect(()=>{if(!p)return()=>{$.patch({active:null}),x||P.LockScreenVisible.set(!0)}},[p]),s.useEffect(()=>{var r,t;if(f||!i.current||!v.current)return;switch(c){case"Landscape":if((r=q)!=null&&r.value)return;w({marginRight:"9rem"}),y.Styles.Rotation.set(90);break;case"Video":y.Styles.Rotation.set(0),w({marginLeft:"12rem"});break;default:y.Styles.Rotation.set(0),w({marginLeft:"3rem"});break}if(c==="Landscape"){if((t=q)!=null&&t.value)return;i.current.resizeByAspect(16/9)}else(c==="Video"||c==="Photo")&&i.current.resizeByAspect(3/4);d("Camera",{action:"toggleLandscape",toggled:c==="Landscape"},"OK"),d("Camera",{action:"toggleVideo",toggled:c==="Video"},"OK");const e=window.innerWidth;e>1920&&i.current.setQuality(1920/e),X()},[c,v.current]),s.useEffect(()=>{if(!v.current)return o("info","camera app is not active, not triggering flipCamera");d("Camera",{action:"flipCamera",value:h},"OK"),X()},[h]);const B=s.useRef(!0),G=async(e,r)=>{const t=fe(e.size/1e3,2);S&&d("toggleFlashlight",{toggled:!1},"OK");try{const a=await me(r?"Video":"Image",e);if(!a)throw new Error("Failed to upload media (URL is null)");return M(a),o("info",`Saving ${r?"video":"photo"} to gallery (${t}kb) - ${a}, args(${a}, ${t}, ${h&&!r?"selfie":null})`),await ge(a,t,h&&!r?"selfie":null,!0),!0}catch(a){throw a}};s.useEffect(()=>{if(B.current){B.current=!1;return}if(S&&!f&&d("toggleFlashlight",{toggled:!1},"OK"),!f)return;const e=i.current.startRecording(async t=>{if(f&&O(!1),!v.current)return o("info","camera app is not active, not saving video");C(!0);try{await G(t,!0),o("info","Video uploaded successfully"),C(!1)}catch(a){o("error","Could not upload video",a),C(!1),k(a.message),await new Promise(b=>setTimeout(b,1e4)),k(null)}}),r=setInterval(()=>{j(t=>t+1)},1e3);return()=>{j(0),clearInterval(r),e&&e.state==="recording"&&e.stop()}},[f]);const re=e=>{let r=(e%60).toString().padStart(2,"0"),t=(Math.floor(e/60)%60).toString().padStart(2,"0");return Math.floor(e/3600).toString().padStart(2,"0")+":"+t+":"+r},H=async()=>{var r,t;if(E)return o("info","Returning since an image is currently uploading");if(S&&await d("toggleFlashlight",{toggled:!0},"OK"),c=="Video"){await d("Camera",{action:"toggleHud",toggled:f},"OK"),O(a=>!a);return}(t=(r=y.Settings.value)==null?void 0:r.sound)!=null&&t.silent||y.SoundManager.set({url:"./assets/sound/other/cameraShutter.mp3"}),K(!0),V.IndicatorVisible.set(!1),C(!0),o("info","Uploading image, converting to blob");const e=await i.current.takePhoto();try{await G(e,!1),o("info","Image uploaded successfully"),C(!1),V.IndicatorVisible.set(!0)}catch(a){o("error","Could not upload image",a),C(!1),k(a.message),V.IndicatorVisible.set(!0),await new Promise(b=>setTimeout(b,1e4)),k(null)}K(!1)};return n(Q,{children:g("div",{className:"camera-container",children:[g("div",{className:"camera-header",children:[n("div",{className:"flash",onClick:()=>U(e=>!e),children:!f&&S?n(ie,{}):n(oe,{})}),c==="Video"&&g(Q,{children:[n("div",{className:"timer",children:re(Z)}),n("span",{})]})]}),g("div",{className:`camera-body ${c=="Landscape"?"rotate":""}`,children:[n("canvas",{ref:I,style:{visibility:Y?"hidden":"visible"}}),E&&g("div",{className:"loading",children:[n(ce,{size:80,speed:1,color:"#ffffff"}),n("div",{className:"uploading",ref:L,children:"Uploading..."})]}),z&&n("div",{className:"loading",children:g("div",{className:"uploading",children:["Failed to upload, tell the server owner to check their API keys in lb-phone/server/apiKeys.lua",n("br",{}),n("br",{}),z]})})]}),g("div",{className:"camera-bottom",children:[n("div",{className:"camera-types",style:ee,children:m.map((e,r)=>n("div",{className:`${c===e&&"active"}`,onClick:()=>N(e),children:_(`APPS.CAMERA.${e.toUpperCase()}`)},r))}),g("div",{className:"camera-buttons",children:[n("div",{className:"image-gallery",ref:F,onClick:()=>{!J&&!x||(d("Camera",{action:"close"},"OK"),y.Styles.Rotation.set(0),$.patch({active:{name:"Photos",data:{photo:R.APPS.CAMERA.lastImage.value}}}))}}),n("div",{className:"camera-button",onClick:()=>H(),children:n("div",{className:"camera-button-container",children:n("div",{className:`camera-button-inner ${c=="Video"&&`${c} ${f==!0&&"Recording"}`}`})})}),n("div",{className:"flip-camera",onClick:()=>D(e=>!e),children:n(le,{})})]})]})]})})}export{Ce as default};
